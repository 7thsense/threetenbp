<!--
  @author Fabio Kung (fabio.kung@gmail.com)
  @author Michael Nascimento Santos
  @author Oliver Fischer (o.b.fischer@swe-blog.net)
-->
<project name="jsr-310-ri" default="dist">
    <description>
        Reference Implementation for the JSR 310 - Date and Time API
    </description>

    <property file="build.properties" />
    <property file="version.properties"/>

    <property name="jarCoreName" value="jsr-310-ri-core-${version.full}" />
    <property name="jarExtraName" value="jsr-310-ri-extra-${version.full}" />
    <property name="jarOpenJDKName" value="jsr-310-ri-openjdk-${version.full}" />
    <property name="jarOracleName" value="jsr-310-ri-oracle-${version.full}" />
    <property name="jarAllName" value="jsr-310-ri-${version.full}" />
    <property name="distFileName" value="jsr-310-${version.full}.zip"/>
    
    <macrodef name="get-dependency">
        <attribute name="group" />
        <attribute name="artifact" />
        <attribute name="version" />
        <attribute name="variant" default="" />
        <attribute name="dest" />
        <sequential>
            <get
                src="${maven.ibiblio.url}/@{group}/@{artifact}/@{version}/@{artifact}-@{version}@{variant}"
                dest="@{dest}/@{artifact}-@{version}@{variant}"
                verbose="true"
                usetimestamp="true" ignoreerrors="true"/>
        </sequential>
    </macrodef>

    <path id="main.path">
        <pathelement location="${core.main.classes}" />
        <pathelement location="${extra.main.classes}" />
        <pathelement location="${oracle.main.classes}" />
        <pathelement location="${ojdk.main.classes}" />
        <pathelement location="lib/main/ZoneRuleInfo-TZDB-all.jar"/>
    </path>

    <path id="test.path">
        <path refid="main.path" />
        <pathelement location="${core.test.classes}" />
        <pathelement location="${extra.test.classes}" />
        <pathelement location="${oracle.test.classes}" />
        <pathelement location="${ojdk.test.classes}" />
        <pathelement location="src/main/resources"/>
        <pathelement location="lib/main/ZoneRuleInfo-TZDB-all.jar"/>
        <fileset dir="lib/test">
            <include name="**/*.jar" />
        </fileset>
    </path>

    <path id="emma.lib" >
        <pathelement location="${lib.coverage}/emma-2.0.5312.jar" />
        <pathelement location="${lib.coverage}/emma_ant-2.0.5312.jar" />
    </path>

    <target name="resolve-deps">
        <mkdir dir="${lib.main}" />
        <mkdir dir="${lib.test}" />
        <mkdir dir="${lib.coverage}" />

        <get-dependency group="org/testng" artifact="testng" version="5.8" variant="-jdk15" dest="${lib.test}" />

        <get-dependency group="emma" artifact="emma" version="2.0.5312" dest="${lib.coverage}" />
        <get-dependency group="emma" artifact="emma_ant" version="2.0.5312" dest="${lib.coverage}" />
    </target>

    <target name="init" depends="resolve-deps">
        <tstamp />
    </target>

    <target name="clean" depends="cleanAll" description="clean up" />

    <target name="cleanAll" description="clean up">
        <delete dir="${build}" />
        <delete dir="${dist}" />
    </target>

    <target name="compileCore" depends="init">
        <mkdir  dir="${core.main.classes}"/>
        <javac srcdir="${core.main}" destdir="${core.main.classes}" debug="true" includeantruntime="false">
            <classpath refid="main.path"/>
        </javac>
    </target>

    <target name="compileExtra" depends="compileCore">
        <mkdir  dir="${extra.main.classes}"/>
        <javac srcdir="${extra.main}" destdir="${extra.main.classes}" includeantruntime="false">
            <classpath location="${core.main.classes}"/>
            <classpath refid="main.path"/>            
        </javac>
    </target>

    <target name="compileOpenJDK" depends="compileCore">
        <mkdir  dir="${ojdk.main.classes}"/>
        <javac srcdir="${ojdk.main}" destdir="${ojdk.main.classes}" nowarn="true" bootclasspath="${java.home}/lib/rt.jar" includeantruntime="false">
            <classpath refid="main.path"/>
        </javac>
    </target>

    <target name="compileOracle" depends="compileCore">
        <mkdir dir="${oracle.main.classes}"/>
        <javac  srcdir="${oracle.main}" destdir="${oracle.main.classes}" includeantruntime="false">
            <classpath location="${core.main.classes}"/>
            <classpath refid="main.path"/>
        </javac>
    </target>

    <target name="compileTZDB" depends="compileCore">
        <mkdir dir="${tzdata.main.workarea}"/>
        <copy todir="${tzdata.main.workarea}">
            <fileset dir="${tzdata.main}" includes="tzdata*.tar.gz"/>
            <mapper type="glob" from="tzdata*.tar.gz" to="*/tzdb.tar.gz" />
        </copy>
        <subant genericantfile="build.xml" target="tzdb-unpack">
            <dirset dir="${tzdata.main.workarea}" includes="*" />
        </subant>
        <java classpath="${core.main.classes}" classname="javax.time.calendar.zone.TZDBZoneRulesCompiler" fork="true" failonerror="true">
            <arg line="-srcdir ${tzdata.main.workarea}" />
            <arg line="-dstdir ${lib.main}" />
            <arg line="${tzdb.files}" />
        </java>
    </target>
    <target name="tzdb-unpack">
        <echo message="${basedir}"></echo>
        <gunzip src="${basedir}/tzdb.tar.gz" />
        <untar src="${basedir}/tzdb.tar" dest="${basedir}" />
        <delete file="${basedir}/tzdb.tar" />
    </target>

    <target name="compileAll" depends="compileCore, compileExtra, compileOracle, compileOpenJDK, compileTZDB" description="compile all sources" />

    <target name="javadoc" depends="init" description="generates javadoc for the api">
      <mkdir dir="${build.javadoc}"/>
      <javadoc sourcepath="${core.main}" destdir="${build.javadoc}"
               classpathref="main.path"
               windowtitle="JSR-310 - Date and Time API"
               failonerror="true"
               packagenames="javax.time**/*,java.util**/*"
               overview="${core.main}/javax/time/overview.html" />
    </target>

    <target name="compile-core-tests" depends="compileCore">
        <mkdir dir="${core.test.classes}" />
        <javac srcdir="${core.test}" destdir="${core.test.classes}" classpathref="test.path" includeantruntime="false" />
    </target>

    <target name="compile-extra-tests" depends="compileExtra,compile-core-tests">
        <mkdir dir="${extra.test.classes}" />
        <javac srcdir="${extra.test}" destdir="${extra.test.classes}" classpathref="test.path"  includeantruntime="false" />
    </target>

    <target name="test-core" depends="compile-core-tests">
        <taskdef resource="testngtasks" classpathref="test.path" />
        <testng classpathref="test.path" outputDir="${core.test.classes}" sourceDir="${core.test}" haltonfailure="true" verbose="2">
            <jvmarg value="-Xmx512M" />
            <classfileset dir="${core.test.classes}" includes="**/Test*.class" excludes="java/util/*" />
        </testng>
    </target>

    <target name="test-extra" depends="compile-extra-tests">
        <taskdef resource="testngtasks" classpathref="test.path" />
        <testng classpathref="test.path" outputDir="${extra.test.classes}" sourceDir="${extra.test}" haltonfailure="true" verbose="2">
            <jvmarg value="-Xmx512M" />
            <classfileset dir="${extra.test.classes}" includes="**/Test*.class" excludes="java/util/*" />
        </testng>
    </target>

    <target name="testScales" depends="compile-core-tests" description="run the scales tests">
        <taskdef resource="testngtasks" classpathref="test.path" />
        <testng classpathref="test.path" outputDir="${core.test.classes}" sourceDir="${core.test}" haltonfailure="true" verbose="2">
            <jvmarg value="-Xmx512M" />
            <classfileset dir="${core.test.classes}" includes="javax/time/scales/Test*.class" excludes="java/util/*" />
        </testng>
    </target>

    <target name="test" depends="test-core,test-extra" description="run tests" />

    <target name="coverage" depends="compile-core-tests" description="test coverage">
        <taskdef resource="emma_ant.properties" classpathref="emma.lib" />
        <mkdir dir="${coverage}" />
           <emmajava libclasspathref="emma.lib"
                   fullmetadata="yes"
                   sourcepath="${core.main}"
                   classname="javax.time.AllTest"
                classpathref="test.path">
               <jvmarg value="-Xmx512M" />
               <filter includes="javax.time.*" excludes="*Test*, *Mock*, *Performance*, *Examples*" />
              <txt outfile="${coverage}/coverage.txt" />
               <html outfile="${coverage}/coverage.html" metrics="method:90,block:90,line:90,class:95" />
        </emmajava>
    </target>

    <target  name="jarOracle" depends="compileOracle">
        <mkdir dir="${dist}" />        
        <mkdir dir="${dist}/lib" />
        <jar jarfile="${dist}/lib/${jarOracleName}">
          <fileset dir="${oracle.main.classes}"/>
        </jar>
    </target>

    <target  name="jarOpenJDK" depends="compileOpenJDK">
        <mkdir dir="${dist}" />
        <mkdir dir="${dist}/lib" />
        <jar jarfile="${dist}/lib/${jarOpenJDKName}">
          <fileset dir="${ojdk.main.classes}"/>
        </jar>
    </target>

    <target  name="jarExtra" depends="compileExtra">
        <mkdir dir="${dist}" />
        <mkdir dir="${dist}/lib" />
        <jar jarfile="${dist}/lib/${jarExtraName}">
          <fileset dir="${extra.main.classes}"/>
        </jar>
    </target>

    <target name="jarCore" depends="compileCore">
        <mkdir dir="${dist}" />
        <mkdir dir="${dist}/lib" />
        <jar jarfile="${dist}/lib/${jarCoreName}">
          <fileset dir="${core.main.classes}"/>
          <fileset dir="src/main/resources"/>
        </jar>
    </target>

    <target name="jarAll" depends="compileAll">
        <mkdir dir="${dist}" />
        <mkdir dir="${dist}/lib" />
        <jar jarfile="${dist}/lib/${jarAllName}">
          <fileset dir="${ojdk.main.classes}"/>
          <fileset dir="${oracle.main.classes}"/>
          <fileset dir="${extra.main.classes}"/>
          <fileset dir="${core.main.classes}"/>
        </jar>
    </target>

    <target name="jar" depends="compileAll" description="build a jar file">
        <delete dir="${dist}" />
        <mkdir dir="${dist}" />
        <jar jarfile="${dist}/${ant.project.name}-${DSTAMP}.jar" basedir="${build.main}" />
    </target>

    <target name="dist" depends="jarAll, jarCore, jarExtra, jarOpenJDK, jarOracle" description="generate the distribution">
        <mkdir dir="${dist}/${src}" />
        <copy todir="${dist}/${src}">
            <fileset dir="${src}"/>
        </copy>
        <copy todir="${dist}/lib" flatten="true">
            <fileset dir="${src}" includes="**/ZoneRuleInfo*.jar"/>
        </copy>
        <copy todir="${dist}/nbproject">
            <fileset dir="nbproject"/>
        </copy>
        <copy file=".classpath" todir="${dist}" />
        <copy file=".project" todir="${dist}" />
        <copy file="build.xml" todir="${dist}" />
        <copy file="checkstyle.xml" todir="${dist}" />
        <copy file="LICENSE.txt" todir="${dist}" />
        <copy file="LICENSE_OpenJDK.txt" todir="${dist}" />
        <copy file="README.txt" todir="${dist}" />
        <copy file="TODO.txt" todir="${dist}" />
        <zip destfile="${distFileName}" basedir="${dist}" />
    </target>

    <target name="testExamples" depends="compile-core-tests" description="outputs some examples to system out">
        <java classname="javax.time.Examples" classpathref="test.path" fork="true"/>
    </target>
</project>
